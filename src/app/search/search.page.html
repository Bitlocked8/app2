<ion-content class="white-content">

  <!-- Mostrar carrito vacÃ­o -->
  <div class="empty-state" *ngIf="carrito.length === 0">
    <p>No has aÃ±adido productos al carrito ðŸ˜¢</p>
    <ion-text color="medium">Explora productos y aÃ±ade lo que mÃ¡s te guste.</ion-text>
  </div>
  <ion-button *ngIf="carrito.length > 0" class="add-button" (click)="abrirModalSeleccion()">
    Ver Productos Seleccionables
  </ion-button>
  <ion-button *ngIf="carrito.length > 0" class="add-button" (click)="abrirModalHistorial()">
  Ver Historial de Pagos
</ion-button>

  <!-- Lista de productos en carrito -->
  <ion-list class="custom-carrito-list" *ngIf="carrito.length > 0">
    <ion-item *ngFor="let item of carrito; let i = index" class="carrito-item">
      <ion-card class="cart-card" (click)="abrirModalEnvio(item)">
        <ion-card-header>
          <ion-card-title>{{ i + 1 }}. {{ item.producto.nombre ?? 'Producto sin nombre' }}</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <p>Cantidad: {{ item.cantidad }}</p>
          <p *ngIf="item.observaciones">{{ item.observaciones }}</p>
          <p>Precio: ${{ item.precioTotal | number:'1.2-2' }}</p>
        </ion-card-content>
      </ion-card>
    </ion-item>
  </ion-list>

  <!-- Modal timeline de envÃ­o -->
  <ion-modal [isOpen]="modalEnvioAbierto" (didDismiss)="cerrarModalEnvio()" class="custom-modal">
    <ng-template>
      <div class="modal-container">
        <ion-button (click)="cerrarModalEnvio()" fill="clear" class="close-btn">âœ•</ion-button>

        <div class="modal-content" *ngIf="productoSeleccionado">
          <h2>{{ productoSeleccionado.producto.nombre ?? 'Producto sin nombre' }}</h2>
          <div class="producto-cantidad-total">
            <p class="cantidad">Cantidad: {{ productoSeleccionado.cantidad }}</p>
            <p class="total">Total: ${{ productoSeleccionado.precioTotal | number:'1.2-2' }}</p>
          </div>

          <div class="timeline">
            <div class="step"
              [class.active]="['AÃ±adido','Pago parcial','Pago total','Enviado','Recibido'].includes(productoSeleccionado.estado ?? '')">
              <div class="circle"></div>
              <div class="label">AÃ±adido</div>
            </div>
            <div class="step"
              [class.active]="['Pago parcial','Pago total','Enviado','Recibido'].includes(productoSeleccionado.estado ?? '')">
              <div class="circle"></div>
              <div class="label">Pago parcial</div>
            </div>
            <div class="step"
              [class.active]="['Pago total','Enviado','Recibido'].includes(productoSeleccionado.estado ?? '')">
              <div class="circle"></div>
              <div class="label">Pago total</div>
            </div>
            <div class="step" [class.active]="['Enviado','Recibido'].includes(productoSeleccionado.estado ?? '')">
              <div class="circle"></div>
              <div class="label">Enviado</div>
            </div>
            <div class="step" [class.active]="(productoSeleccionado.estado ?? '') === 'Recibido'">
              <div class="circle"></div>
              <div class="label">Recibido</div>
            </div>
          </div>
        </div>
      </div>
    </ng-template>
  </ion-modal>

 <ion-modal [isOpen]="modalSeleccionAbierto" (didDismiss)="cerrarModalSeleccion()" class="custom-modal">
  <ng-template>
    <div class="modal-container">
      <ion-button fill="clear" class="close-btn" (click)="cerrarModalSeleccion()">âœ•</ion-button>

      <!-- SelecciÃ³n de productos -->
      <div class="modal-content" *ngIf="productosSeleccionados.length > 0 && !comprobanteVisible">
        <h2>Selecciona Productos</h2>
        <ion-list class="custom-carrito-list">
          <ion-item *ngFor="let item of productosSeleccionados" class="carrito-item">
            <ion-checkbox slot="start" [(ngModel)]="item.seleccionado"></ion-checkbox>
            <div class="producto-cantidad-total">
              <p class="nombre">{{ item.producto.nombre ?? 'Producto sin nombre' }}</p>
              <p class="cantidad">Cantidad: {{ item.cantidad }}</p>
              <p class="total">Total: ${{ item.precioTotal | number:'1.2-2' }}</p>
              <p *ngIf="item.estado === 'Pago parcial'" class="estado-parcial">Pago Parcial</p>
            </div>
          </ion-item>

          <div class="producto-cantidad-total total-seleccion">
            <p>Total seleccionado: ${{ getTotalSeleccion() | number:'1.2-2' }}</p>
          </div>
        </ion-list>

        <!-- Botones de pago -->
        <div class="acciones-pago">
          <ion-button  class="add-button"  (click)="mostrarComprobante('parcial')">
            Pagar Parcial
          </ion-button>
          <ion-button  class="add-button" (click)="mostrarComprobante('total')">
            Pagar Total
          </ion-button>
        </div>
      </div>

      <!-- Subida de comprobante -->
      <div *ngIf="comprobanteVisible" class="modal-content">
        <h3>Subir comprobante para {{ tipoPagoComprobante === 'parcial' ? 'Pago Parcial' : 'Pago Total' }}</h3>
        <input type="file" class="file-input" (change)="archivoSeleccionado($event)" />

        <ion-button expand="full" class="add-button"  (click)="confirmarComprobante()">
          Confirmar Comprobante
        </ion-button>
      </div>

      <!-- No hay productos -->
      <div class="modal-content" *ngIf="productosSeleccionados.length === 0">
        <h3>No hay productos disponibles para realizar el pago</h3>
      </div>
    </div>
  </ng-template>
</ion-modal>

<ion-modal [isOpen]="modalHistorialAbierto" (didDismiss)="cerrarModalHistorial()" class="custom-modal">
  <ng-template>
    <div class="modal-container">
      <ion-button fill="clear" class="close-btn" (click)="cerrarModalHistorial()">âœ•</ion-button>

      <div class="modal-content" *ngIf="productosPagados.length > 0">
        <h2>Historial de Pagos</h2>

        <ion-list class="custom-carrito-list">
          <ion-item *ngFor="let item of productosPagados" class="carrito-item">
            <div class="producto-cantidad-total">
              <p class="nombre">{{ item.producto.nombre ?? 'Producto sin nombre' }}</p>
              <p class="cantidad">Cantidad: {{ item.cantidad }}</p>
              <p>Total: ${{ item.precioTotal | number:'1.2-2' }}</p>
              <p>Estado: <strong>{{ item.estado }}</strong></p>
              <p>Fecha: {{ item.fecha | date:'short' }}</p>
            </div>
          </ion-item>
        </ion-list>
      </div>

      <div *ngIf="productosPagados.length === 0"  class="modal-content">
        <h3>No hay pagos registrados todavÃ­a</h3>
      </div>
    </div>
  </ng-template>
</ion-modal>


</ion-content>