<ion-content class="white-content">

  <!-- Mostrar carrito vacÃ­o -->
  <div class="empty-state" *ngIf="carrito.length === 0">
    <p>No has aÃ±adido productos al carrito ðŸ˜¢</p>
    <ion-text color="medium">Explora productos y aÃ±ade lo que mÃ¡s te guste.</ion-text>
  </div>
  <ion-button *ngIf="carrito.length > 0" class="add-button" (click)="abrirModalSeleccion()">
    Ver Productos Seleccionables
  </ion-button>
  <!-- Lista de productos en carrito -->
  <ion-list class="custom-carrito-list" *ngIf="carrito.length > 0">
    <ion-item *ngFor="let item of carrito; let i = index" class="carrito-item">
      <ion-card class="cart-card" (click)="abrirModalEnvio(item)">
        <ion-card-header>
          <ion-card-title>{{ i + 1 }}. {{ item.producto.nombre ?? 'Producto sin nombre' }}</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <p>Cantidad: {{ item.cantidad }}</p>
          <p *ngIf="item.observaciones">{{ item.observaciones }}</p>
          <p>Precio: ${{ item.precioTotal | number:'1.2-2' }}</p>
        </ion-card-content>
      </ion-card>
    </ion-item>
  </ion-list>

  <!-- Modal timeline de envÃ­o -->
  <ion-modal [isOpen]="modalEnvioAbierto" (didDismiss)="cerrarModalEnvio()" class="custom-modal">
    <ng-template>
      <div class="modal-container">
        <ion-button (click)="cerrarModalEnvio()" fill="clear" class="close-btn">âœ•</ion-button>

        <div class="modal-content" *ngIf="productoSeleccionado">
          <h2>{{ productoSeleccionado.producto.nombre ?? 'Producto sin nombre' }}</h2>
          <div class="producto-cantidad-total">
            <p class="cantidad">Cantidad: {{ productoSeleccionado.cantidad }}</p>
            <p class="total">Total: ${{ productoSeleccionado.precioTotal | number:'1.2-2' }}</p>
          </div>

          <div class="timeline">
            <div class="step"
              [class.active]="['AÃ±adido','Pago parcial','Pago total','Enviado','Recibido'].includes(productoSeleccionado.estado ?? '')">
              <div class="circle"></div>
              <div class="label">AÃ±adido</div>
            </div>
            <div class="step"
              [class.active]="['Pago parcial','Pago total','Enviado','Recibido'].includes(productoSeleccionado.estado ?? '')">
              <div class="circle"></div>
              <div class="label">Pago parcial</div>
            </div>
            <div class="step"
              [class.active]="['Pago total','Enviado','Recibido'].includes(productoSeleccionado.estado ?? '')">
              <div class="circle"></div>
              <div class="label">Pago total</div>
            </div>
            <div class="step" [class.active]="['Enviado','Recibido'].includes(productoSeleccionado.estado ?? '')">
              <div class="circle"></div>
              <div class="label">Enviado</div>
            </div>
            <div class="step" [class.active]="(productoSeleccionado.estado ?? '') === 'Recibido'">
              <div class="circle"></div>
              <div class="label">Recibido</div>
            </div>
          </div>
        </div>
      </div>
    </ng-template>
  </ion-modal>

  <ion-modal [isOpen]="modalSeleccionAbierto" (didDismiss)="cerrarModalSeleccion()" class="custom-modal">
    <ng-template>
      <div class="modal-container">
        <ion-button fill="clear" class="close-btn" (click)="cerrarModalSeleccion()">âœ•</ion-button>

        <div class="modal-content" *ngIf="productosSeleccionados.length > 0 && !comprobanteVisible">
          <h2>Selecciona Productos</h2>

          <ion-list class="custom-carrito-list">
            <ion-item *ngFor="let item of productosSeleccionados" class="carrito-item">
              <ion-checkbox slot="start" [(ngModel)]="item.seleccionado"></ion-checkbox>
              <div class="producto-cantidad-total">
                <p class="nombre">{{ item.producto.nombre ?? 'Producto sin nombre' }}</p>
                <p class="cantidad">Cantidad: {{ item.cantidad }}</p>
                <p class="total">Total: ${{ item.precioTotal | number:'1.2-2' }}</p>
              </div>
            </ion-item>

            <div class="producto-cantidad-total total-seleccion">
              <p>Total seleccionado: ${{ getTotalSeleccion() | number:'1.2-2' }}</p>
            </div>
          </ion-list>

          <!-- Botones de pago fake -->
          <div class="acciones-pago">
            <ion-button expand="full" color="warning" (click)="mostrarComprobante('parcial')">
              Pagar Parcial (Fake)
            </ion-button>

            <ion-button expand="full" color="success" (click)="mostrarComprobante('total')">
              Pagar Total (Fake)
            </ion-button>
          </div>
        </div>

        <!-- Subida de comprobante -->
        <div *ngIf="comprobanteVisible" class="comprobante-container">
          <h3>Subir comprobante para {{ tipoPagoComprobante === 'parcial' ? 'Pago Parcial' : 'Pago Total' }}</h3>
          <input type="file" (change)="archivoSeleccionado($event)" />
          <ion-button expand="full" color="primary" (click)="confirmarComprobante()">
            Confirmar Comprobante
          </ion-button>
        </div>

        <!-- Si no hay productos -->
        <div class="modal-content" *ngIf="productosSeleccionados.length === 0">
          <p>No hay productos en el carrito.</p>
        </div>
      </div>
    </ng-template>
  </ion-modal>


</ion-content>