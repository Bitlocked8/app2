<ion-content class="ion-padding">

  <div *ngIf="compras.length === 0" class="empty-state">
    <p>No hay compras registradas aún.</p>
  </div>

  <div *ngFor="let compra of compras" class="timeline-item">
    <ion-item lines="none" (click)="abrirModal(compra)">
      <ion-avatar slot="start">
        <img [src]="compra.imagen" alt="{{ compra.producto }}">
      </ion-avatar>
      <ion-label>
        <h2>{{ compra.producto }}</h2>
        <p>Cantidad: {{ compra.cantidad }} | Precio: ${{ compra.precio }}</p>
        <p>Método: {{ compra.metodoPago }}</p>
        <p class="fecha">{{ compra.fecha | date:'short' }}</p>
      </ion-label>
    </ion-item>
  </div>

  <ion-modal #modal>
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Detalle de la Compra</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="cerrarModal()">Cerrar</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>

      <ion-content class="ion-padding" *ngIf="selectedCompra">
        <ion-item lines="none">
          <ion-avatar slot="start">
            <img [src]="selectedCompra.imagen" alt="{{ selectedCompra.producto }}">
          </ion-avatar>
          <ion-label>
            <h2>{{ selectedCompra.producto }}</h2>
            <p>Cantidad: {{ selectedCompra.cantidad }}</p>
            <p>Precio: ${{ selectedCompra.precio }}</p>
            <p>Método de pago: {{ selectedCompra.metodoPago }}</p>
            <p>Estado: {{ selectedCompra.estado }}</p>
            <p>Fecha: {{ selectedCompra.fecha | date:'short' }}</p>
          </ion-label>
        </ion-item>

        <div class="timeline-vertical">
          <div *ngFor="let estado of getTimeline(selectedCompra)" class="timeline-step">
            <input type="radio" disabled [checked]="estado.done">
            <label>{{ estado.label }}</label>
          </div>
        </div>

        <div *ngIf="selectedCompra.estado === 'carrito' || selectedCompra.estado === 'pendiente'" class="acciones">
        

          <div *ngIf="metodoPago === 'contado'">
            <ion-segment [(ngModel)]="metodoPagoAhora">
              <ion-segment-button value="qr">QR</ion-segment-button>
              <ion-segment-button value="tarjeta">Tarjeta</ion-segment-button>
              <ion-segment-button value="paypal">PayPal</ion-segment-button>
            </ion-segment>

            <div *ngIf="metodoPagoAhora === 'qr'" style="text-align:center; margin-top: 16px;">
              <p>Escanea este código QR para pagar:</p>
              <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=Pago%20Fake" alt="QR de pago" style="margin: 10px auto; display:block;">
              <ion-item>
                <ion-label>Subir comprobante</ion-label>
                <input type="file" accept="image/*" (change)="onComprobanteSubido($event)" />
              </ion-item>
            </div>

            <div *ngIf="metodoPagoAhora === 'tarjeta'">
              <ion-item>
                <ion-label position="floating">Número de tarjeta</ion-label>
                <ion-input type="text"></ion-input>
              </ion-item>
              <ion-item>
                <ion-label position="floating">Fecha de expiración</ion-label>
                <ion-input type="month"></ion-input>
              </ion-item>
              <ion-item>
                <ion-label position="floating">CVV</ion-label>
                <ion-input type="number" maxlength="3"></ion-input>
              </ion-item>
              <ion-item>
                <ion-label>Subir comprobante</ion-label>
                <input type="file" accept="image/*" (change)="onComprobanteSubido($event)" />
              </ion-item>
            </div>

            <div *ngIf="metodoPagoAhora === 'paypal'" style="margin-top: 16px;">
              <p><strong>Datos de la empresa para el pago:</strong></p>
              <ion-list>
                <ion-item>
                  <ion-label>Email PayPal:</ion-label>
                  <ion-text>empresa-fake@paypal.com</ion-text>
                </ion-item>
                <ion-item>
                  <ion-label>Nombre:</ion-label>
                  <ion-text>Empresa Ejemplo SRL</ion-text>
                </ion-item>
              </ion-list>
              <p style="margin-top: 10px;">Envíe el pago a los datos indicados y suba el comprobante.</p>
              <ion-item>
                <ion-label>Subir comprobante</ion-label>
                <input type="file" accept="image/*" (change)="onComprobanteSubido($event)" />
              </ion-item>
            </div>

          </div>
            <ion-button color="success" [disabled]="!comprobanteSubido" (click)="pagar(selectedCompra)">
            Pagar ahora
          </ion-button>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>

</ion-content>
